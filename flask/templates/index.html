{% extends "layout.html" %}

{% block title %}Celara - Exoplanet Classifier{% endblock %}

{% block content %}
<!-- Upload Section -->
<div id="uploadSection">
    <!-- Input Mode Selector -->
    <div class="mb-4">
        <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="inputMode" id="csvMode" value="csv" checked>
            <label class="btn btn-outline-primary" for="csvMode">
                <i class="bi bi-table"></i> CSV File
            </label>
            
            <input type="radio" class="btn-check" name="inputMode" id="lightcurveMode" value="lightcurve">
            <label class="btn btn-outline-primary" for="lightcurveMode">
                <i class="bi bi-file-binary"></i> FITS File
            </label>
            
            <input type="radio" class="btn-check" name="inputMode" id="koiMode" value="koi">
            <label class="btn btn-outline-primary" for="koiMode">
                <i class="bi bi-search"></i> Single KOI
            </label>
        </div>
    </div>

    <!-- CSV Mode -->
    <div id="csvModeSection">
        <div class="upload-zone" id="uploadZone">
            <i class="bi bi-cloud-arrow-up upload-icon"></i>
            <h4 class="mb-3">Drop your CSV file here</h4>
            <p class="text-muted mb-3">or click to browse</p>
            <input type="file" id="fileInput" accept=".csv,.txt" style="display: none;">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-file-earmark-arrow-up"></i> Select File
            </button>
        </div>
        
        <div class="mt-3 text-center text-muted small">
            <i class="bi bi-info-circle"></i> Required columns: target_id, period, epoch, duration, stellar_radius, teff, snr
        </div>
    </div>

    <!-- Light Curve Mode -->
    <div id="lightcurveModeSection" style="display: none;">
        <div class="upload-zone" id="lightcurveZone">
            <i class="bi bi-file-binary upload-icon"></i>
            <h4 class="mb-3">Drop a FITS file here</h4>
            <p class="text-muted mb-3">Single light curve file (.fits or .fit)</p>
            <input type="file" id="lightcurveInput" accept=".fits,.fit" style="display: none;">
            <button class="btn btn-primary" onclick="document.getElementById('lightcurveInput').click()">
                <i class="bi bi-file-earmark-arrow-up"></i> Select FITS File
            </button>
        </div>
        
        <div class="mt-3 text-center text-muted small">
            <i class="bi bi-info-circle"></i> Supports single FITS files from Kepler/TESS missions
        </div>
    </div>

    <!-- KOI Mode -->
    <div id="koiModeSection" style="display: none;">
        <div class="mb-3">
            <label for="koiInput" class="form-label">Enter a single KOI ID or KIC number:</label>
            <input type="text" class="form-control" id="koiInput" 
                   placeholder="e.g., KOI-123 or KIC-456 or 123456">
        </div>
        
        <div id="koiSubmitSection" class="mt-3" style="display: none;">
            <button class="btn btn-primary w-100" onclick="uploadFile()">
                <i class="bi bi-download"></i> Download & Analyze KOI
            </button>
        </div>
        
        <div class="mt-3 text-center text-muted small">
            <i class="bi bi-info-circle"></i> Will automatically download light curve from MAST archive
        </div>
    </div>
    
    <!-- Selected File Display -->
    <div id="fileSelected" class="mt-3" style="display: none;">
        <div class="alert alert-info d-flex align-items-center justify-content-between">
            <div>
                <i class="bi bi-file-earmark-text"></i>
                <strong id="fileName"></strong>
                <span id="fileSize" class="ms-2 text-muted"></span>
            </div>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearFile()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <button class="btn btn-primary w-100" onclick="uploadFile()">
            <i class="bi bi-rocket-takeoff"></i> Analyze Exoplanets
        </button>
    </div>
</div>

<!-- Loading Section -->
<div id="loadingSection" style="display: none;">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="mb-2">Analyzing Light Curves...</h4>
        <p class="text-muted">This may take a few moments</p>
        <div class="progress mt-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 100%"></div>
        </div>
    </div>
</div>

<!-- Results Section -->
<div id="resultsSection" style="display: none;">
    <div class="results-section">
        <h3 class="mb-4 text-center">
            <i class="bi bi-graph-up"></i> Analysis Results
        </h3>
        
        <!-- Summary Statistics Table -->
        <div class="mb-4">
            <h5 class="mb-3"><i class="bi bi-bar-chart"></i> Analysis Summary</h5>
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Count</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Total Targets</strong></td>
                            <td><span class="badge bg-primary" id="totalTargets">0</span></td>
                            <td><span class="text-muted">100%</span></td>
                        </tr>
                        <tr>
                            <td><strong>Planet Candidates</strong></td>
                            <td><span class="badge bg-success" id="planetCandidates">0</span></td>
                            <td><span class="text-success" id="planetPercentage">0%</span></td>
                        </tr>
                        <tr>
                            <td><strong>High Confidence</strong></td>
                            <td><span class="badge bg-warning" id="highConfidence">0</span></td>
                            <td><span class="text-warning" id="highConfidencePercentage">0%</span></td>
                        </tr>
                        <tr>
                            <td><strong>Average Confidence</strong></td>
                            <td><span class="badge bg-info" id="avgConfidence">0%</span></td>
                            <td><span class="text-muted">-</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Table 1: Summary of All KOIs -->
        <div class="mb-4">
            <h5 class="mb-3"><i class="bi bi-table"></i> KOI Summary</h5>
            <div class="table-responsive">
                <table class="table table-dark table-hover" id="summaryTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Target ID</th>
                            <th>Planet Probability</th>
                            <th>Classification</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Download & Reset -->
        <div class="d-flex gap-2 mt-4">
            <a id="downloadBtn" href="#" class="btn btn-primary flex-fill" download>
                <i class="bi bi-download"></i> Download Results
            </a>
            <button onclick="resetApp()" class="btn btn-outline-light flex-fill">
                <i class="bi bi-arrow-clockwise"></i> New Analysis
            </button>
        </div>
    </div>
</div>
        </div>
    </div>
</div>

<!-- Error Section -->
<div id="errorSection" style="display: none;">
    <div class="alert alert-danger" role="alert">
        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Error</h5>
        <p id="errorMessage" class="mb-0"></p>
    </div>
    <button class="btn btn-secondary w-100" onclick="resetApp()">
        <i class="bi bi-arrow-left"></i> Try Again
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedFile = null;
    let currentMode = 'csv';
    
    // Mode switching
    document.querySelectorAll('input[name="inputMode"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            currentMode = e.target.value;
            switchInputMode(currentMode);
        });
    });
    
    function switchInputMode(mode) {
        // Hide all sections
        document.getElementById('csvModeSection').style.display = 'none';
        document.getElementById('lightcurveModeSection').style.display = 'none';
        document.getElementById('koiModeSection').style.display = 'none';
        
        // Show selected section
        if (mode === 'csv') {
            document.getElementById('csvModeSection').style.display = 'block';
        } else if (mode === 'lightcurve') {
            document.getElementById('lightcurveModeSection').style.display = 'block';
        } else if (mode === 'koi') {
            document.getElementById('koiModeSection').style.display = 'block';
        }
        
        // Clear previous selections
        clearFile();
    }
    
    // CSV Upload zone interactions
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    
    if (uploadZone && fileInput) {
        uploadZone.addEventListener('click', () => fileInput.click());
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
    }
    
    // Light curve file handling
    const lightcurveZone = document.getElementById('lightcurveZone');
    const lightcurveInput = document.getElementById('lightcurveInput');
    
    if (lightcurveZone && lightcurveInput) {
        lightcurveZone.addEventListener('click', () => lightcurveInput.click());
        
        lightcurveZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            lightcurveZone.classList.add('dragover');
        });
        
        lightcurveZone.addEventListener('dragleave', () => {
            lightcurveZone.classList.remove('dragover');
        });
        
        lightcurveZone.addEventListener('drop', (e) => {
            e.preventDefault();
            lightcurveZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleLightcurveFile(files[0]);
            }
        });
        
        lightcurveInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleLightcurveFile(e.target.files[0]);
            }
        });
    }
    
    function handleLightcurveFile(file) {
        if (!file.name.endsWith('.fits') && !file.name.endsWith('.fit')) {
            alert('Please select a FITS file');
            return;
        }
        
        selectedFile = file;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = 
            `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
        document.getElementById('fileSelected').style.display = 'block';
    }
    
    function handleFileSelect(file) {
        if (currentMode === 'csv' && !file.name.endsWith('.csv') && !file.name.endsWith('.txt')) {
            alert('Please select a CSV or TXT file');
            return;
        }
        
        if (currentMode === 'lightcurve' && !file.name.endsWith('.fits') && !file.name.endsWith('.fit')) {
            alert('Please select a FITS file');
            return;
        }
        
        selectedFile = file;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = 
            `(${(file.size / 1024).toFixed(2)} KB)`;
        document.getElementById('fileSelected').style.display = 'block';
    }
    
    function clearFile() {
        selectedFile = null;
        if (fileInput) fileInput.value = '';
        document.getElementById('lightcurveInput').value = '';
        document.getElementById('koiInput').value = '';
        document.getElementById('fileSelected').style.display = 'none';
        document.getElementById('koiSubmitSection').style.display = 'none';
    }
    
    async function uploadFile() {
        // Show loading
        document.getElementById('uploadSection').style.display = 'none';
        document.getElementById('loadingSection').style.display = 'block';
        
        // Create form data based on current mode
        const formData = new FormData();
        formData.append('mode', currentMode);
        
        try {
            if (currentMode === 'csv') {
                if (!selectedFile) {
                    showError('Please select a CSV file');
                    return;
                }
                formData.append('file', selectedFile);
            } else if (currentMode === 'lightcurve') {
                if (!selectedFile) {
                    showError('Please select a FITS file');
                    return;
                }
                formData.append('file', selectedFile);
            } else if (currentMode === 'koi') {
                const koiText = document.getElementById('koiInput').value.trim();
                if (!koiText) {
                    showError('Please enter a KOI ID or KIC number');
                    return;
                }
                formData.append('koi_id', koiText);
            }
            
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                displayResults(data);
            } else {
                showError(data.error || 'An error occurred during processing');
            }
        } catch (error) {
            showError('Failed to connect to server: ' + error.message);
        }
    }
    
    function displayResults(data) {
        // Hide loading, show results
        document.getElementById('loadingSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'block';
        
        // Update statistics
        const totalTargets = data.summary.total_targets;
        const planetCandidates = data.summary.planet_candidates;
        const highConfidence = data.summary.high_confidence;
        
        document.getElementById('totalTargets').textContent = totalTargets;
        document.getElementById('planetCandidates').textContent = planetCandidates;
        document.getElementById('highConfidence').textContent = highConfidence;
        document.getElementById('avgConfidence').textContent = 
            (data.summary.avg_confidence * 100).toFixed(1) + '%';
        
        // Calculate and display percentages
        const planetPercentage = totalTargets > 0 ? ((planetCandidates / totalTargets) * 100).toFixed(1) : 0;
        const highConfidencePercentage = totalTargets > 0 ? ((highConfidence / totalTargets) * 100).toFixed(1) : 0;
        
        document.getElementById('planetPercentage').textContent = planetPercentage + '%';
        document.getElementById('highConfidencePercentage').textContent = highConfidencePercentage + '%';
        
        // Populate Summary Table (all candidates)
        const summaryTableBody = document.getElementById('summaryTableBody');
        const allCandidates = data.all_candidates || data.top_candidates || [];
        summaryTableBody.innerHTML = allCandidates.map((candidate, idx) => {
            const probability = (candidate.prediction * 100).toFixed(1);
            const classification = candidate.prediction > 0.5 ? 'Planet Candidate' : 'Non-Planet';
            const classColor = candidate.prediction > 0.5 ? 'text-success' : 'text-muted';
            
            return `
                <tr>
                    <td><span class="badge bg-primary">${idx + 1}</span></td>
                    <td><strong>${candidate.target_id}</strong></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="me-2">${probability}%</span>
                            <div class="progress flex-fill" style="height: 6px;">
                                <div class="progress-bar bg-info" style="width: ${probability}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="${classColor}">${classification}</span>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Set download link
        document.getElementById('downloadBtn').href = data.download_url;
    }
    
    function showError(message) {
        document.getElementById('loadingSection').style.display = 'none';
        document.getElementById('errorSection').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
    }
    
    function resetApp() {
        // Hide all sections
        document.getElementById('errorSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'none';
        document.getElementById('loadingSection').style.display = 'none';
        
        // Show upload section
        document.getElementById('uploadSection').style.display = 'block';
        
        // Clear file
        clearFile();
    }
    
    // Show KOI submit button when in KOI mode and text is entered
    document.getElementById('koiInput').addEventListener('input', (e) => {
        const koiSubmitSection = document.getElementById('koiSubmitSection');
        if (currentMode === 'koi' && e.target.value.trim()) {
            koiSubmitSection.style.display = 'block';
        } else {
            koiSubmitSection.style.display = 'none';
        }
    });
</script>
{% endblock %}